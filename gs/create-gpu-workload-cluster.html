<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Create GPU Workload Cluster - Kubernetes Cluster API Provider for Oracle Cloud Infrastructure</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href=".././src/css/mdbook-admonish.css">
        <link rel="stylesheet" href="../././mdbook-admonish.css">
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../introduction.html">Introduction</a></li><li class="chapter-item expanded affix "><a href="../prerequisites.html">Prerequisites</a></li><li class="chapter-item expanded "><a href="../gs/gs.html"><strong aria-hidden="true">1.</strong> Getting Started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../gs/overview.html"><strong aria-hidden="true">1.1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../gs/custom-machine-images.html"><strong aria-hidden="true">1.2.</strong> Prepare custom OCI images</a></li><li class="chapter-item expanded "><a href="../gs/iam.html"><strong aria-hidden="true">1.3.</strong> Configure users and policies</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../gs/iam/iam-oke.html"><strong aria-hidden="true">1.3.1.</strong> Configure policies for an OKE cluster</a></li><li class="chapter-item expanded "><a href="../gs/iam/iam-self-provisioned.html"><strong aria-hidden="true">1.3.2.</strong> Configure policies for a self-provisioned cluster</a></li><li class="chapter-item expanded "><a href="../gs/iam/iam-ocid.html"><strong aria-hidden="true">1.3.3.</strong> User configuration and OCIDs</a></li></ol></li><li class="chapter-item expanded "><a href="../gs/provision-mgmt-cluster.html"><strong aria-hidden="true">1.4.</strong> Provision a management cluster</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../gs/mgmt/mgmt-kind.html"><strong aria-hidden="true">1.4.1.</strong> Provision a management cluster with kind</a></li><li class="chapter-item expanded "><a href="../gs/mgmt/mgmt-oke.html"><strong aria-hidden="true">1.4.2.</strong> Provision a management cluster with OKE</a></li></ol></li><li class="chapter-item expanded "><a href="../gs/install-cluster-api.html"><strong aria-hidden="true">1.5.</strong> Install Cluster API for Oracle Cloud Infrastructure</a></li><li class="chapter-item expanded "><a href="../gs/create-workload-cluster.html"><strong aria-hidden="true">1.6.</strong> Create Workload Cluster</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../gs/create-mhc-workload-cluster.html"><strong aria-hidden="true">1.6.1.</strong> MachineHealthChecks</a></li><li class="chapter-item expanded "><a href="../gs/create-gpu-workload-cluster.html" class="active"><strong aria-hidden="true">1.6.2.</strong> Create GPU Workload Cluster</a></li><li class="chapter-item expanded "><a href="../gs/create-windows-workload-cluster.html"><strong aria-hidden="true">1.6.3.</strong> Create Windows Workload Cluster</a></li></ol></li><li class="chapter-item expanded "><a href="../gs/create-workload-templates.html"><strong aria-hidden="true">1.7.</strong> Create Workload Templates</a></li><li class="chapter-item expanded "><a href="../gs/externally-managed-cluster-infrastructure.html"><strong aria-hidden="true">1.8.</strong> Using externally managed infrastructure</a></li><li class="chapter-item expanded "><a href="../gs/install-oci-ccm.html"><strong aria-hidden="true">1.9.</strong> Install Oracle Cloud Infrastructure Cloud Controller Manager</a></li><li class="chapter-item expanded "><a href="../gs/install-csi.html"><strong aria-hidden="true">1.10.</strong> Install Container Storage Interface (CSI)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../gs/pvc-bv.html"><strong aria-hidden="true">1.10.1.</strong> Provision a PVC on the Block Volume Service</a></li><li class="chapter-item expanded "><a href="../gs/pvc-fss.html"><strong aria-hidden="true">1.10.2.</strong> Provision a PVC on the File Storage Service</a></li></ol></li><li class="chapter-item expanded "><a href="../gs/customize-worker-node.html"><strong aria-hidden="true">1.11.</strong> Customize worker nodes</a></li><li class="chapter-item expanded "><a href="../gs/multi-tenancy.html"><strong aria-hidden="true">1.12.</strong> Multi Tenancy</a></li><li class="chapter-item expanded "><a href="../gs/advanced.html"><strong aria-hidden="true">1.13.</strong> Advanced Options</a></li></ol></li><li class="chapter-item expanded "><a href="../networking/networking.html"><strong aria-hidden="true">2.</strong> Networking Guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../networking/infrastructure.html"><strong aria-hidden="true">2.1.</strong> Default Network Infrastructure</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../networking/calico.html"><strong aria-hidden="true">2.1.1.</strong> Using Calico</a></li><li class="chapter-item expanded "><a href="../networking/antrea.html"><strong aria-hidden="true">2.1.2.</strong> Using Antrea</a></li><li class="chapter-item expanded "><a href="../networking/ipv6.html"><strong aria-hidden="true">2.1.3.</strong> Using IPv6</a></li></ol></li><li class="chapter-item expanded "><a href="../networking/custom-networking.html"><strong aria-hidden="true">2.2.</strong> Custom Networking</a></li><li class="chapter-item expanded "><a href="../networking/private-cluster.html"><strong aria-hidden="true">2.3.</strong> Private Cluster</a></li></ol></li><li class="chapter-item expanded "><a href="../managed/managedcluster.html"><strong aria-hidden="true">3.</strong> Managed Clusters (OKE)</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../managed/virtual-nodes-and-enhanced-clusters.html"><strong aria-hidden="true">3.1.</strong> Virtual Nodes and Enhanced Clusters</a></li><li class="chapter-item expanded "><a href="../managed/self-managed-nodes.html"><strong aria-hidden="true">3.2.</strong> Self managed nodes</a></li><li class="chapter-item expanded "><a href="../managed/boot-volume-expansion.html"><strong aria-hidden="true">3.3.</strong> Boot volume expansion</a></li><li class="chapter-item expanded "><a href="../managed/networking.html"><strong aria-hidden="true">3.4.</strong> Networking customizations</a></li><li class="chapter-item expanded "><a href="../managed/features.html"><strong aria-hidden="true">3.5.</strong> Features</a></li></ol></li><li class="chapter-item expanded "><a href="../reference/reference.html"><strong aria-hidden="true">4.</strong> Reference</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../reference/api-reference.html"><strong aria-hidden="true">4.1.</strong> API Reference</a></li><li class="chapter-item expanded "><a href="../reference/glossary.html"><strong aria-hidden="true">4.2.</strong> Glossary</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Kubernetes Cluster API Provider for Oracle Cloud Infrastructure</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/oracle/cluster-api-provider-oci" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="create-a-gpu-workload-cluster"><a class="header" href="#create-a-gpu-workload-cluster">Create a GPU workload cluster</a></h1>
<h2 id="accessing-gpu-shapes"><a class="header" href="#accessing-gpu-shapes">Accessing GPU Shapes</a></h2>
<p>Some shapes are limited to specific regions and specific Availability Domains (AD).
In order to make sure the workload cluster comes up check the region and AD for 
shape availability.</p>
<h3 id="check-shape-availability"><a class="header" href="#check-shape-availability">Check shape availability</a></h3>
<p>Make sure the <a href="https://docs.oracle.com/en-us/iaas/Content/API/SDKDocs/cliinstall.htm">OCI CLI</a> is installed. Then set the AD information if using 
muti-AD regions.</p>
<blockquote>
<p>NOTE: Use the <a href="https://docs.oracle.com/en-us/iaas/Content/General/Concepts/regions.htm">OCI Regions and Availability Domains</a> page to figure out which 
regions have multiple ADs.</p>
</blockquote>
<pre><code class="language-bash">oci iam availability-domain list --compartment-id=&lt;your compartment&gt; --region=&lt;region&gt;
</code></pre>
<p>Using the AD <code>name</code> from the output start searching for GPU shape availability.</p>
<pre><code class="language-bash">oci compute shape list --compartment-id=&lt;your compartment&gt; --profile=DEFAULT --region=us-ashburn-1 --availability-domain=&lt;your AD ID&gt; | grep GPU
 
&quot;shape-name&quot;: &quot;BM.GPU3.8&quot;
&quot;shape-name&quot;: &quot;BM.GPU4.8&quot;
&quot;shape-name&quot;: &quot;VM.GPU3.1&quot;
&quot;shape&quot;: &quot;VM.GPU2.1&quot;
</code></pre>
<blockquote>
<p>NOTE: If the output is empty then the compartment for that region/AD doesn't have GPU shapes.
If you are unable to locate any shapes you may need to submit a
<a href="https://docs.oracle.com/en-us/iaas/Content/General/Concepts/servicelimits.htm#computelimits">service limit increase request</a></p>
</blockquote>
<h2 id="create-a-new-gpu-workload-cluster-an-ubuntu-custom-image"><a class="header" href="#create-a-new-gpu-workload-cluster-an-ubuntu-custom-image">Create a new GPU workload cluster an Ubuntu custom image</a></h2>
<blockquote>
<p>NOTE: Nvidia GPU drivers aren't supported for Oracle Linux at this time. Ubuntu is currently
the only supported OS.</p>
</blockquote>
<p>When launching a multi-AD region shapes are likely be limited to a specific AD (example: <code>US-ASHBURN-AD-2</code>).
To make sure the cluster comes up without issue specifically target just that AD for the GPU worker nodes.
To do that modify the released version of the <code>cluster-template-failure-domain-spread.yaml</code> template.</p>
<p>Download the <a href="https://github.com/oracle/cluster-api-provider-oci/releases">latest <code>cluster-template-failure-domain-spread.yaml</code></a> file and save it as
<code>cluster-template-gpu.yaml</code>.</p>
<p>Make sure the modified template has only the <code>MachineDeployment</code> section(s) where there is GPU
availability and remove all the others. See <a href="#example-yaml-file">the full example file</a>
that targets only AD 2 (OCI calls them Availability Domains while Cluster-API calls them Failure Domains).</p>
<h3 id="virtual-instances"><a class="header" href="#virtual-instances">Virtual instances</a></h3>
<p>The following command will create a workload cluster comprising a single 
control plane node and single GPU worker node using the default values as specified in the preceding 
<a href="../gs/create-workload-cluster.html#workload-cluster-parameters">Workload Cluster Parameters</a> table:</p>
<blockquote>
<p>NOTE: The <code>OCI_NODE_MACHINE_TYPE_OCPUS</code> must match the OPCU count of the GPU shape.
See the <a href="https://docs.oracle.com/en-us/iaas/Content/Compute/References/computeshapes.htm">Compute Shapes</a> page to get the OCPU count for the specific shape.</p>
</blockquote>
<pre><code class="language-bash">OCI_COMPARTMENT_ID=&lt;compartment-id&gt; \
OCI_IMAGE_ID=&lt;ubuntu-custom-image-id&gt; \
OCI_SSH_KEY=&lt;ssh-key&gt;  \
NODE_MACHINE_COUNT=1 \
OCI_NODE_MACHINE_TYPE=VM.GPU3.1 \
OCI_NODE_MACHINE_TYPE_OCPUS=6 \
OCI_CONTROL_PLANE_MACHINE_TYPE_OCPUS=1 \
OCI_CONTROL_PLANE_MACHINE_TYPE=VM.Standard3.Flex \
CONTROL_PLANE_MACHINE_COUNT=1 \
OCI_SHAPE_MEMORY_IN_GBS= \
KUBERNETES_VERSION=v1.24.4 \
clusterctl generate cluster &lt;cluster-name&gt; \
--target-namespace default \
--from cluster-template-gpu.yaml | kubectl apply -f -
</code></pre>
<h3 id="bare-metal-instances"><a class="header" href="#bare-metal-instances">Bare metal instances</a></h3>
<p>The following command uses the <code>OCI_CONTROL_PLANE_MACHINE_TYPE</code> and <code>OCI_NODE_MACHINE_TYPE</code> 
parameters to specify bare metal shapes instead of using CAPOCI's default virtual 
instance shape. The <code>OCI_CONTROL_PLANE_PV_TRANSIT_ENCRYPTION</code> and <code>OCI_NODE_PV_TRANSIT_ENCRYPTION</code> 
parameters disable encryption of data in flight between the bare metal instance and the block storage resources.</p>
<blockquote>
<p>NOTE: The <code>OCI_NODE_MACHINE_TYPE_OCPUS</code> must match the OPCU count of the GPU shape.
See the <a href="https://docs.oracle.com/en-us/iaas/Content/Compute/References/computeshapes.htm">Compute Shapes</a> page to get the OCPU count for the specific shape.</p>
</blockquote>
<pre><code class="language-bash">OCI_COMPARTMENT_ID=&lt;compartment-id&gt; \
OCI_IMAGE_ID=&lt;ubuntu-custom-image-id&gt; \
OCI_SSH_KEY=&lt;ssh-key&gt;  \
OCI_NODE_MACHINE_TYPE=BM.GPU3.8 \
OCI_NODE_MACHINE_TYPE_OCPUS=52 \
OCI_NODE_PV_TRANSIT_ENCRYPTION=false \
OCI_CONTROL_PLANE_MACHINE_TYPE=VM.Standard3.Flex \
CONTROL_PLANE_MACHINE_COUNT=1 \
OCI_SHAPE_MEMORY_IN_GBS= \
KUBERNETES_VERSION=v1.24.4 \
clusterctl generate cluster &lt;cluster-name&gt; \
--target-namespace default \
--from cluster-template-gpu.yaml | kubectl apply -f -
</code></pre>
<h3 id="access-workload-cluster-kubeconfig"><a class="header" href="#access-workload-cluster-kubeconfig">Access workload cluster Kubeconfig</a></h3>
<p>Execute the following command to list all the workload clusters present:</p>
<pre><code class="language-bash">kubectl get clusters -A
</code></pre>
<p>Execute the following command to access the kubeconfig of a workload cluster:</p>
<pre><code class="language-bash">clusterctl get kubeconfig &lt;cluster-name&gt; -n default &gt; &lt;cluster-name&gt;.kubeconfig
</code></pre>
<h3 id="install-a-cni-provider-oci-cloud-controller-manager-and-csi-in-a-self-provisioned-cluster"><a class="header" href="#install-a-cni-provider-oci-cloud-controller-manager-and-csi-in-a-self-provisioned-cluster">Install a CNI Provider, OCI Cloud Controller Manager and CSI in a self-provisioned cluster</a></h3>
<p>To provision the CNI and Cloud Controller Manager follow the <a href="../gs/create-workload-cluster.html#install-a-cni-provider">Install a CNI Provider</a> 
and the <a href="../gs/create-workload-cluster.html#install-oci-cloud-controller-manager-and-csi-in-a-self-provisioned-cluster">Install OCI Cloud Controller Manager</a> sections.</p>
<h3 id="install-nvidia-gpu-operator"><a class="header" href="#install-nvidia-gpu-operator">Install Nvidia GPU Operator</a></h3>
<p>Setup the worker instances to use the GPUs install the <a href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/overview.html">Nvidia GPU Operator</a>. </p>
<p>For the most up-to-date install instructions see the <a href="https://docs.nvidia.com/datacenter/cloud-native/gpu-operator/getting-started.html#install-nvidia-gpu-operator">official install instructions</a>. They
layout how to install the <a href="https://helm.sh/docs/intro/install/">Helm tool</a> and how to setup the Nvidia helm repo. </p>
<p>With Helm setup you can now install the GPU-Operator</p>
<pre><code class="language-bash">helm install --wait --generate-name \
     -n gpu-operator --create-namespace \
     nvidia/gpu-operator
</code></pre>
<p>The pods will take a while to come up but you can check the status:</p>
<pre><code class="language-bash">kubectl --&lt;cluster-name&gt;.kubeconf get pods -n gpu-operator
</code></pre>
<h3 id="test-gpu-on-worker-node"><a class="header" href="#test-gpu-on-worker-node">Test GPU on worker node</a></h3>
<p>Once all of the GPU-Operator pods are <code>running</code> or <code>completed</code> deploy the test pod:</p>
<pre><code class="language-bash">cat &lt;&lt;EOF | kubectl --kubeconfig=&lt;cluster-name&gt;.kubeconf apply -f -
apiVersion: v1
kind: Pod
metadata:
name: cuda-vector-add
spec:
restartPolicy: OnFailure
containers:
- name: cuda-vector-add
# https://github.com/kubernetes/kubernetes/blob/v1.7.11/test/images/nvidia-cuda/Dockerfile
image: &quot;registry.k8s.io/cuda-vector-add:v0.1&quot;
resources:
limits:
nvidia.com/gpu: 1 # requesting 1 GPU
EOF
</code></pre>
<p>Then check the output logs of the <code>cuda-vector-add</code> test pod:</p>
<pre><code class="language-bash">kubectl --kubeconfig=&lt;cluster-name&gt;.kubeconf logs cuda-vector-add -n default
 
[Vector addition of 50000 elements]
Copy input data from the host memory to the CUDA device
CUDA kernel launch with 196 blocks of 256 threads
Copy output data from the CUDA device to the host memory
Test PASSED
Done
</code></pre>
<h2 id="example-yaml-file"><a class="header" href="#example-yaml-file">Example yaml file</a></h2>
<p>This is an example file using a modified version of <code>cluster-template-failure-domain-spread.yaml</code> 
to target AD 2 (example: <code>US-ASHBURN-AD-2</code>). </p>
<pre><code class="language-yaml">apiVersion: cluster.x-k8s.io/v1beta1
kind: Cluster
metadata:
  labels:
    cluster.x-k8s.io/cluster-name: &quot;${CLUSTER_NAME}&quot;
  name: &quot;${CLUSTER_NAME}&quot;
  namespace: &quot;${NAMESPACE}&quot;
spec:
  clusterNetwork:
    pods:
      cidrBlocks:
        - ${POD_CIDR:=&quot;192.168.0.0/16&quot;}
    serviceDomain: ${SERVICE_DOMAIN:=&quot;cluster.local&quot;}
    services:
      cidrBlocks:
        - ${SERVICE_CIDR:=&quot;10.128.0.0/12&quot;}
  infrastructureRef:
    apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
    kind: OCICluster
    name: &quot;${CLUSTER_NAME}&quot;
    namespace: &quot;${NAMESPACE}&quot;
  controlPlaneRef:
    apiVersion: controlplane.cluster.x-k8s.io/v1beta1
    kind: KubeadmControlPlane
    name: &quot;${CLUSTER_NAME}-control-plane&quot;
    namespace: &quot;${NAMESPACE}&quot;
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: OCICluster
metadata:
  labels:
    cluster.x-k8s.io/cluster-name: &quot;${CLUSTER_NAME}&quot;
  name: &quot;${CLUSTER_NAME}&quot;
spec:
  compartmentId: &quot;${OCI_COMPARTMENT_ID}&quot;
---
kind: KubeadmControlPlane
apiVersion: controlplane.cluster.x-k8s.io/v1beta1
metadata:
  name: &quot;${CLUSTER_NAME}-control-plane&quot;
  namespace: &quot;${NAMESPACE}&quot;
spec:
  version: &quot;${KUBERNETES_VERSION}&quot;
  replicas: ${CONTROL_PLANE_MACHINE_COUNT}
  machineTemplate:
    infrastructureRef:
      kind: OCIMachineTemplate
      apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
      name: &quot;${CLUSTER_NAME}-control-plane&quot;
      namespace: &quot;${NAMESPACE}&quot;
  kubeadmConfigSpec:
    clusterConfiguration:
      kubernetesVersion: ${KUBERNETES_VERSION}
      apiServer:
        certSANs: [localhost, 127.0.0.1]
      dns: {}
      etcd: {}
      networking: {}
      scheduler: {}
    initConfiguration:
      nodeRegistration:
        criSocket: /var/run/containerd/containerd.sock
        kubeletExtraArgs:
          cloud-provider: external
          provider-id: oci://{{ ds[&quot;id&quot;] }}
    joinConfiguration:
      discovery: {}
      nodeRegistration:
        criSocket: /var/run/containerd/containerd.sock
        kubeletExtraArgs:
          cloud-provider: external
          provider-id: oci://{{ ds[&quot;id&quot;] }}
---
kind: OCIMachineTemplate
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
metadata:
  name: &quot;${CLUSTER_NAME}-control-plane&quot;
spec:
  template:
    spec:
      imageId: &quot;${OCI_IMAGE_ID}&quot;
      compartmentId: &quot;${OCI_COMPARTMENT_ID}&quot;
      shape: &quot;${OCI_CONTROL_PLANE_MACHINE_TYPE=VM.Standard.E4.Flex}&quot;
      shapeConfig:
        ocpus: &quot;${OCI_CONTROL_PLANE_MACHINE_TYPE_OCPUS=1}&quot;
      metadata:
        ssh_authorized_keys: &quot;${OCI_SSH_KEY}&quot;
      isPvEncryptionInTransitEnabled: ${OCI_CONTROL_PLANE_PV_TRANSIT_ENCRYPTION=true}
---
apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
kind: OCIMachineTemplate
metadata:
  name: &quot;${CLUSTER_NAME}-md&quot;
spec:
  template:
    spec:
      imageId: &quot;${OCI_IMAGE_ID}&quot;
      compartmentId: &quot;${OCI_COMPARTMENT_ID}&quot;
      shape: &quot;${OCI_NODE_MACHINE_TYPE=VM.Standard.E4.Flex}&quot;
      shapeConfig:
        ocpus: &quot;${OCI_NODE_MACHINE_TYPE_OCPUS=1}&quot;
      metadata:
        ssh_authorized_keys: &quot;${OCI_SSH_KEY}&quot;
      isPvEncryptionInTransitEnabled: ${OCI_NODE_PV_TRANSIT_ENCRYPTION=true}
---
apiVersion: bootstrap.cluster.x-k8s.io/v1alpha4
kind: KubeadmConfigTemplate
metadata:
  name: &quot;${CLUSTER_NAME}-md&quot;
spec:
  template:
    spec:
      joinConfiguration:
        nodeRegistration:
          kubeletExtraArgs:
            cloud-provider: external
            provider-id: oci://{{ ds[&quot;id&quot;] }}
---
apiVersion: cluster.x-k8s.io/v1beta1
kind: MachineDeployment
metadata:
  name: &quot;${CLUSTER_NAME}-fd-2-md-0&quot;
spec:
  clusterName: &quot;${CLUSTER_NAME}&quot;
  replicas: ${NODE_MACHINE_COUNT}
  selector:
    matchLabels:
  template:
    spec:
      clusterName: &quot;${CLUSTER_NAME}&quot;
      version: &quot;${KUBERNETES_VERSION}&quot;
      bootstrap:
        configRef:
          name: &quot;${CLUSTER_NAME}-md&quot;
          apiVersion: bootstrap.cluster.x-k8s.io/v1beta1
          kind: KubeadmConfigTemplate
      infrastructureRef:
        name: &quot;${CLUSTER_NAME}-md&quot;
        apiVersion: infrastructure.cluster.x-k8s.io/v1beta2
        kind: OCIMachineTemplate
      # Cluster-API calls them Failure Domains while OCI calls them Availability Domains
      # In the example this would be targeting US-ASHBURN-AD-2
      failureDomain: &quot;2&quot;
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../gs/create-mhc-workload-cluster.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../gs/create-windows-workload-cluster.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../gs/create-mhc-workload-cluster.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../gs/create-windows-workload-cluster.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
